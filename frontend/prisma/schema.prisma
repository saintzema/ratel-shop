// ─── FairPrice.ng Production Schema ─────────────────────────────
// Translates every DemoStore / localStorage type into real Postgres tables.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ──────────────────────────────────────────────────────

enum UserRole {
  customer
  seller
  admin
}

enum SellerStatus {
  pending
  active
  frozen
  banned
}

enum KYCStatus {
  not_submitted
  pending
  approved
  rejected
}

enum OrderStatus {
  pending
  processing
  shipped
  delivered
  cancelled
}

enum EscrowStatus {
  held
  seller_confirmed
  buyer_confirmed
  auto_release_eligible
  released
  disputed
  refunded
}

enum TrackingStatus {
  pending
  processing
  shipped
  out_for_delivery
  delivered
}

enum PriceFlag {
  fair
  overpriced
  too_low
  none
  great_deal
}

enum ProductCondition {
  brand_new
  used
  refurbished
}

enum DisputeReason {
  wrong_item
  damaged
  not_received
  not_as_described
  other
}

enum DisputeStatus {
  open
  investigating
  resolved_refund
  resolved_release
}

enum NegotiationStatus {
  pending
  accepted
  rejected
}

enum SupportSource {
  ziva_escalation
  contact_form
  order_issue
  dispute_admin
}

enum SupportStatus {
  new_msg
  read
  replied
  resolved
}

enum NotificationType {
  system
  order
  negotiation
  promo
}

enum ComplaintType {
  price
  quality
  delivery
  scam
  complaint_other
}

enum ComplaintStatus {
  complaint_open
  investigating
  resolved
  dismissed
}

enum PriceAlertType {
  overpriced
  great_deal
}

enum IDType {
  nin
  drivers_license
  voters_card
  passport
}

// ─── Models ─────────────────────────────────────────────────────

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  name       String
  password   String?
  role       UserRole @default(customer)
  avatarUrl  String?
  location   String?
  birthday   String?

  // Relations
  seller          Seller?
  orders          Order[]
  reviews         Review[]
  negotiations    NegotiationRequest[]
  notifications   Notification[]
  complaints      Complaint[]            @relation("UserComplaints")
  supportMessages SupportMessage[]
  disputes        Dispute[]              @relation("BuyerDisputes")
  addresses       Address[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Address {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  label     String  @default("Home")
  street    String
  city      String
  state     String
  country   String  @default("Nigeria")
  isDefault Boolean @default(false)
  phone     String?
}

model Seller {
  id             String       @id @default(cuid())
  userId         String       @unique
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  businessName   String
  ownerName      String?
  ownerEmail     String?
  description    String
  logoUrl        String?
  coverImageUrl  String?
  category       String
  verified       Boolean      @default(false)
  rating         Float        @default(0.0)
  trustScore     Float        @default(50.0)
  status         SellerStatus @default(pending)
  kycStatus      KYCStatus    @default(not_submitted)

  // Business details
  bankName       String?
  accountNumber  String?
  accountName    String?
  storeUrl       String?      @unique
  location       String?
  weeklyOrders   String?
  currencies     String[]
  staffCount     String?
  physicalStores String?

  // Relations
  products      Product[]
  orders        Order[]             @relation("SellerOrders")
  negotiations  NegotiationRequest[] @relation("SellerNegotiations")
  priceAlerts   PriceAlert[]
  complaints    Complaint[]         @relation("SellerComplaints")
  disputes      Dispute[]           @relation("SellerDisputes")
  kycSubmissions KYCSubmission[]

  joinedAt   DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Product {
  id               String           @id @default(cuid())
  sellerId         String
  seller           Seller           @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  sellerName       String

  name             String
  description      String
  price            Float
  originalPrice    Float?
  recommendedPrice Float?
  category         String
  imageUrl         String
  images           String[]
  stock            Int              @default(1)
  priceFlag        PriceFlag        @default(none)
  isSponsored      Boolean          @default(false)
  isActive         Boolean          @default(true)
  avgRating        Float            @default(0.0)
  reviewCount      Int              @default(0)
  soldCount        Int              @default(0)
  condition        ProductCondition @default(brand_new)
  externalUrl      String?
  highlights       String[]
  specs            Json?

  // Relations
  orders        Order[]
  reviews       Review[]
  negotiations  NegotiationRequest[]
  deals         Deal[]
  priceAlerts   PriceAlert[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Order {
  id             String        @id @default(cuid())
  customerId     String
  customer       User          @relation(fields: [customerId], references: [id])
  productId      String
  product        Product       @relation(fields: [productId], references: [id])
  sellerId       String
  seller         Seller        @relation("SellerOrders", fields: [sellerId], references: [id])

  amount         Float
  quantity       Int           @default(1)
  status         OrderStatus   @default(pending)
  escrowStatus   EscrowStatus  @default(held)
  shippingAddress String
  paymentMethod  String        @default("paystack")

  // Tracking
  trackingStatus TrackingStatus @default(pending)
  trackingId     String?        @unique
  carrier        String?
  trackingSteps  Json?

  // Lifecycle timestamps
  sellerConfirmedAt DateTime?
  buyerConfirmedAt  DateTime?
  escrowReleasedAt  DateTime?

  // Denormalized display names
  customerName   String?
  sellerName     String?

  // Relations
  disputes       Dispute[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model NegotiationRequest {
  id             String            @id @default(cuid())
  productId      String
  product        Product           @relation(fields: [productId], references: [id])
  customerId     String
  customer       User              @relation(fields: [customerId], references: [id])
  customerName   String
  sellerId       String
  seller         Seller            @relation("SellerNegotiations", fields: [sellerId], references: [id])

  proposedPrice  Float
  message        String?
  status         NegotiationStatus @default(pending)

  counterPrice   Float?
  counterMessage String?
  counterStatus  NegotiationStatus?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Review {
  id               String  @id @default(cuid())
  userId           String
  user             User    @relation(fields: [userId], references: [id])
  userName         String
  productId        String
  product          Product @relation(fields: [productId], references: [id])

  rating           Int
  title            String
  body             String
  verifiedPurchase Boolean @default(false)

  createdAt  DateTime @default(now())
}

model Deal {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id])

  discountPct Float
  startAt     DateTime
  endAt       DateTime
  isActive    Boolean  @default(true)
}

model KYCSubmission {
  id          String   @id @default(cuid())
  sellerId    String
  seller      Seller   @relation(fields: [sellerId], references: [id])
  sellerName  String

  idType      IDType
  idNumber    String
  documentUrl String
  status      KYCStatus @default(pending)
  reviewedBy  String?
  reviewNotes String?

  createdAt   DateTime  @default(now())
  reviewedAt  DateTime?
}

model PriceAlert {
  id          String        @id @default(cuid())
  productId   String
  product     Product       @relation(fields: [productId], references: [id])
  productName String
  sellerId    String
  seller      Seller        @relation(fields: [sellerId], references: [id])
  sellerName  String

  alertType   PriceAlertType
  marketAvg   Float
  sellerPrice Float

  createdAt   DateTime @default(now())
}

model Complaint {
  id          String          @id @default(cuid())
  userId      String
  user        User            @relation("UserComplaints", fields: [userId], references: [id])
  userName    String
  sellerId    String
  seller      Seller          @relation("SellerComplaints", fields: [sellerId], references: [id])
  sellerName  String
  orderId     String?

  type        ComplaintType
  description String
  status      ComplaintStatus @default(complaint_open)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Dispute {
  id          String        @id @default(cuid())
  orderId     String
  order       Order         @relation(fields: [orderId], references: [id])
  buyerId     String
  buyer       User          @relation("BuyerDisputes", fields: [buyerId], references: [id])
  buyerName   String
  buyerEmail  String
  sellerId    String
  seller      Seller        @relation("SellerDisputes", fields: [sellerId], references: [id])
  sellerName  String
  productName String
  amount      Float

  reason      DisputeReason
  description String
  status      DisputeStatus @default(open)
  adminNotes  String?

  createdAt   DateTime  @default(now())
  resolvedAt  DateTime?
}

model Notification {
  id        String           @id @default(cuid())
  userId    String?
  user      User?            @relation(fields: [userId], references: [id])

  type      NotificationType
  message   String
  read      Boolean          @default(false)
  link      String?

  createdAt DateTime @default(now())
}

model SupportMessage {
  id             String        @id @default(cuid())
  userName       String
  userEmail      String
  userId         String?
  user           User?         @relation(fields: [userId], references: [id])

  subject        String
  message        String
  source         SupportSource @default(contact_form)
  status         SupportStatus @default(new_msg)
  transcript     String?       @db.Text
  orderId        String?

  targetUserId   String?
  targetUserEmail String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SystemSetting {
  id                 String   @id @default("global") // Single row pattern
  
  // Market & Fees
  platformMargin     Float    @default(15.0) // Percentage
  serviceCharge      Float    @default(25.0) // Percentage
  standardCommission Float    @default(2.5)  // Percentage
  escrowFee          Float    @default(1000) // Fixed NGN
  doorstepFee        Float    @default(4000) // Fixed NGN
  pickupFee          Float    @default(2500) // Fixed NGN

  // Feature Flags / Toggles
  aiMonitoring       Boolean  @default(true)
  kycVerification    Boolean  @default(false)
  escrowRelease      Boolean  @default(true)
  strictSeller       Boolean  @default(true)

  // JSON for complex data like category margins
  categoryMargins    Json?    // e.g. {"electronics": "10", "fashion": "15"}

  updatedAt          DateTime @updatedAt
}
